<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Fish Room Playback</title>
    <style>
      body { 
        margin: 0; 
        overflow: hidden; 
        font-family: Arial, sans-serif;
        color: white;
      }
      canvas { 
        display: block; 
      }
      #controls {
        position: absolute;
        bottom: 20px;
        left: 0;
        width: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px 0;
        text-align: center;
      }
      #timeline {
        width: 80%;
        margin: 0 auto;
        display: block;
      }
      button {
        background-color: #4CAF50;
        border: none;
        color: white;
        padding: 8px 16px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 14px;
        margin: 4px 2px;
        cursor: pointer;
        border-radius: 4px;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 5px 10px;
        border-radius: 4px;
      }
      #metadata {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        padding: 10px;
        border-radius: 4px;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div id="info">Fish Room Playback</div>
    <div id="metadata"></div>
    <div id="controls">
      <button id="playPauseBtn">Pause</button>
      <input type="range" id="timeline" min="0" value="0" step="1">
      <span id="frameCounter">Frame: 0/0</span>
    </div>
    
    <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.157.0/examples/jsm/"
      }
    }
    </script>
    
    <script type="module">
      import * as THREE from 'three';
      import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
      
      // Main variables
      let scene, camera, renderer, controls;
      let fishPoints, mesh;
      let frames = [];
      let frameIndex = 0;
      let isPlaying = true;
      let frameRate = 10; // frames per second
      let lastTime = 0;
      let frameInterval = 1000 / frameRate;
      let metadata = {};
      let fishModels = {};
      
      // DOM elements
      const playPauseBtn = document.getElementById('playPauseBtn');
      const timeline = document.getElementById('timeline');
      const frameCounter = document.getElementById('frameCounter');
      const metadataEl = document.getElementById('metadata');
      
      init();
      loadJSON();

      function init() {
        // Scene setup
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x111111);
        
        // Camera setup
        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(2, 2, 2);
        
        // Renderer setup
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);
        
        // Controls setup
        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.25;
        
        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);
        
        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(1, 2, 3);
        scene.add(light);
        
        // Grid helper
        const gridHelper = new THREE.GridHelper(5, 10, 0x444444, 0x222222);
        scene.add(gridHelper);
        
        // Coordinate axes
        const axesHelper = new THREE.AxesHelper(1);
        scene.add(axesHelper);
        
        // Event listeners
        window.addEventListener('resize', onWindowResize);
        
        playPauseBtn.addEventListener('click', togglePlayPause);
        
        timeline.addEventListener('input', function() {
          frameIndex = parseInt(this.value);
          updateUI();
          if (!isPlaying) {
            updateFrame(frames[frameIndex]);
            renderer.render(scene, camera);
          }
        });
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
      
      function togglePlayPause() {
        isPlaying = !isPlaying;
        playPauseBtn.textContent = isPlaying ? 'Pause' : 'Play';
      }
      
      async function loadJSON() {
        try {
          const res = await fetch('data.json');
          const json = await res.json();
          frames = json.frames;
          metadata = json.metadata || {};
          
          // Update frameRate if provided in metadata
          if (metadata.frameRate) {
            frameRate = metadata.frameRate;
            frameInterval = 1000 / frameRate;
          }
          
          // Display metadata
          displayMetadata(metadata);
          
          // Update timeline slider
          timeline.max = frames.length - 1;
          updateUI();
          
          // Create fish models if needed
          createFishModels();
          
          // Start animation loop
          animate();
        } catch (error) {
          console.error('Error loading data:', error);
        }
      }
      
      function displayMetadata(metadata) {
        if (!metadata) return;
        
        let html = '<h3>Recording Info</h3>';
        html += `<p>Room: ${metadata.roomName || 'Unknown'}</p>`;
        html += `<p>Date: ${metadata.captureDate ? new Date(metadata.captureDate).toLocaleString() : 'Unknown'}</p>`;
        html += `<p>Duration: ${metadata.duration || 'Unknown'} seconds</p>`;
        html += `<p>Frame Count: ${metadata.frameCount || frames.length}</p>`;
        html += `<p>Device: ${metadata.device || 'Unknown'}</p>`;
        html += `<p>Version: ${metadata.version || '1.0'}</p>`;
        
        metadataEl.innerHTML = html;
      }
      
      function createFishModels() {
        // Create a collection of fish models (simple colored cones)
        fishModels = {
          goldfish: new THREE.ConeGeometry(0.05, 0.15, 8),
          clownfish: new THREE.ConeGeometry(0.04, 0.12, 8),
          default: new THREE.SphereGeometry(0.03, 8, 8)
        };
      }

      function animate(time) {
        requestAnimationFrame(animate);
        
        // Update controls
        controls.update();
        
        if (frames.length === 0) return;
        
        // Update frame based on timing if playing
        if (isPlaying) {
          // Control frame rate
          if (!lastTime) lastTime = time;
          
          if (time - lastTime > frameInterval) {
            frameIndex = (frameIndex + 1) % frames.length;
            updateFrame(frames[frameIndex]);
            updateUI();
            lastTime = time;
          }
        }
        
        renderer.render(scene, camera);
      }
      
      function updateUI() {
        timeline.value = frameIndex;
        frameCounter.textContent = `Frame: ${frameIndex + 1}/${frames.length}`;
      }

      function updateFrame(frame) {
        // Update room mesh
        if (mesh) scene.remove(mesh);
        const geom = new THREE.BufferGeometry();
        const verts = new Float32Array(frame.mesh.vertices.flat());
        geom.setAttribute('position', new THREE.BufferAttribute(verts, 3));
        const indices = new Uint16Array(frame.mesh.triangles.flat());
        geom.setIndex(new THREE.BufferAttribute(indices, 1));
        geom.computeVertexNormals(); // Add normal calculation for better lighting
        
        const mat = new THREE.MeshPhongMaterial({ 
          color: 0x556677, 
          wireframe: true,
          opacity: 0.8,
          transparent: true,
          side: THREE.DoubleSide
        });
        
        mesh = new THREE.Mesh(geom, mat);
        scene.add(mesh);

        // Update fish with new data format
        // Remove existing fish
        scene.children = scene.children.filter(child => !child.userData.isFish);
        
        // Add new fish
        frame.fish.forEach((fish, index) => {
          const fishType = fish.type || 'default';
          const fishGeom = fishModels[fishType] || fishModels.default;
          
          // Use different colors for different fish types
          const fishColor = fishType === 'goldfish' ? 0xFFCC00 : 
                           fishType === 'clownfish' ? 0xFF5500 : 
                           0x00AAFF;
          
          const fishMat = new THREE.MeshPhongMaterial({ 
            color: fishColor,
            shininess: 100
          });
          
          const fishMesh = new THREE.Mesh(fishGeom, fishMat);
          
          // Set position
          const pos = fish.position || [0, 0, 0];
          fishMesh.position.set(pos[0], pos[1], pos[2]);
          
          // Set rotation
          if (fish.rotation) {
            fishMesh.rotation.set(
              fish.rotation[0] * Math.PI/180,
              fish.rotation[1] * Math.PI/180,
              fish.rotation[2] * Math.PI/180
            );
          }
          
          // Mark as fish for easy filtering
          fishMesh.userData.isFish = true;
          fishMesh.userData.fishIndex = index;
          
          scene.add(fishMesh);
        });
      }
    </script>
  </body>
</html>
